\chapter{Sistema multiagente bottom-up para la coherencia de tramas}

El primer objetivo del proyecto es conseguir crear un contexto de personajes primarios, secundarios y extras coherente, es decir, en el que todos los elementos interaccionan con el entorno y entre sí con unas reglas definidas, generando una combinación única de acciones entrelazadas e interrelacionadas.

La hipótesis es utilizar una aproximación bottom-up para generar un conjunto base de agentes que coexistan en un Entorno MADE y eventualmente tengan sucesión, de modo que a lo largo del tiempo la demografía el mundo virtual se renueve, llegando al momento en el que se produce la historia que se desea narrar. En este punto, todo agente tiene unas características coherentes con su entorno.

Si las reglas que definen las acciones y personalidad de los agentes son adecuadas, la solución será óptima para la historia que el creador desea narrar. En última instancia, el objetivo de MADE no es únicamente el de conseguir un mundo coherente y adecuado para el creador y la historia finales, sino que además esas historias sean interesantes. La aproximación para abordar la obtención de esos parámetros específicos queda detallada en la sección \ref{cha:genetic_algorithm}.


\section{Entorno MADE}

El entorno MADE se define como aquel donde conviven los agentes y que coordina su funcionamiento. Sus funciones son las siguientes:

\begin{description}
   \item[Crear un conjunto inicial de agentes:] 

 	El entorno MADE inicializará un conjunto de agentes huérfanos , de edad 0 y perfil asignado secuencialmente. Dichos agentes acaban de nacer en el entorno MADE y deben competir o colaborar para sobrevivir.
   
   \item[Posicionar a los agentes en un mapa:] El Entorno MADE dispone de un mapa, inicialmente cuadrado, compuesto por celdas que pueden ser ocupadas por un único agente. El Entorno ofrece mecanismos para que los agentes descubran a otros agentes en el vecindario y puedan interactuar con ellos.
   
   \item[Iniciar y controlar el paso el tiempo:] Tras la creación y posicionamiento del conjunto inicial de agentes, el Entorno MADE inicializa el contador de tiempo.
   
   \item[Permitir que cada agente se ejecute durante una unidad de tiempo:] El entorno MADE entra en un bucle que finaliza cuando haya iterado el número de unidades de tiempo especificadas en su ejecución. Dicho bucle incluye obtener todos los agentes vivos, reordenar la lista, permitir que cada agente ejecute una iteración de su  ciclo de vida, y eliminar del mapa los agentes que ya no están vivos. 
   
   \item[Ejercer de agente externo que cambia el entorno:] Cada iteración realizada por el entorno MADE implica la colocación de un número de raciones de comida en celdas aleatorias. Un agente sólo podrá comer cuando se halle sobre una celda con ración, por lo que se permitirá que los agentes puedan mover a otros de manera forzosa.
    
   \item[Ofrecer servicios a los agentes:] El Entorno MADE permite a los agentes consultar qué celdas cercanas tienen comida, qué celdas cercanas están ocupadas, qué agentes se encuentran en una posición cercana y qué posiciones cercanas pueden ocupar.
   
   \item[Decidir el perfil de los agentes:] MADE permite la existencia de diferentes perfiles de agentes. Un perfil de agente será un conjunto de probabilidades que rigen sus características y comportamiento.
   
\end{description}


\subsection{Parametrización del Entorno MADE}

El sistema MADE ofrece un mecanismo de configuración del entorno mediante el
uso de un fichero denominado ``evaluation.properties''. Los parámetros que
definen la ejecución del Entorno MADE y que deben ser iguales a los usados para
el proceso creativo, una vez optimizado el cromosoma, son los siguientes:

\begin{verbatim}
#---
global.NUMBER_OF_INITIAL_AGENTS=16
global.MAP_DIMENSION=20
global.FOOD=5
global.DAYS=2000
global.AVERAGE=4
#---
\end{verbatim}


%TODO hablar de madkit y por qué no me ha valido: Necesito realizar demasiadas ejecuciones para cada entorno, así que no me vale un sistema que modele los agentes en tiempo real.

%TODO Hablar de cómo la ejecución secuencial evita condiciones de carrera y bloqueos 

\section{Agente MADE}

%CITE http://es.wikipedia.org/wiki/Agente_inteligente_(Inteligencia_Artificial)
\textit{Un agente inteligente, es una entidad capaz de percibir su entorno, procesar tales percepciones y responder o actuar en su entorno de manera racional, es decir, de manera correcta y tendiendo a maximizar un resultado esperado. Es capaz de percibir su medioambiente con la ayuda de sensores y actuar en ese medio utilizando actuadores (elementos que reaccionan a un estímulo realizando una acción).
En este contexto la racionalidad es la característica que posee una elección de ser correcta, más específicamente, de tender a maximizar un resultado esperado. Este concepto de racionalidad es más general y por ello más adecuado que inteligencia (la cual sugiere entendimiento) para describir el comportamiento de los agentes inteligentes. Por este motivo es mayor el consenso en llamarlos agentes racionales.}

Un agente MADE es aquel que es ejecutado por un Entorno MADE y que utiliza a este para comunicarse con otros agentes.

En las siguientes subsecciones se detallará en funcionamiento del agente MADE implementado para el prototipo y pruebas.


\subsection{Las ratas ligeramente mágicas de la Universidad Invisible en
Ankh-Morpork }

El proyecto MADE ofrece un abanico inmenso en cuanto a sus posibilidades de
implementación. Para este Trabajo Fin de Máster se ha optado por implementar una
sociedad con una base literaria: Las ratas que viven bajo la Universidad
Invisible de la ciudad de Ankh-Morpork, del Universo de Mundodisco, de Terry
Prattchet. Las razones por las que se han elegido dichos agentes son las
siguientes:

\begin{itemize}
\item Se trata de personajes de conducta simple. Comenzar modelando a personajes humanos fue un error que ya se cometió en el inicio del proceso creativo de MADE,y que se deshecho debido a su inmensa complejidad; sin embargo, los personajes seleccionados pueden complicarse si se desea. En el universo de Mundodisco, estas ratas han sido empapadas por constantes fugas de magia que emanan de la Universidad Invisible, por lo que es de imaginar que se le puedan atribuir ciertos comportamientos humanos.
\item No existe apenas literatura sobre ellas, salvo menciones en algún libro, por lo que ofrecen una libertad absoluta a la hora de modelarlas.
\item Experimentar con ratas en una Universidad es algo, históricamente, muy científico.
\end{itemize}

\subsubsection{Diagrama de estados}

Los agentes seleccionados tienen una serie de estados que quedan descritos en el siguiente diagrama:

%TODO figura estados

\subsubsection{Parametrización de un agente}

Un agente queda parametrizado según los siguientes valores reales, que en su conjunto definen un perfil:

\begin{description}
\item[FEATURE\_BITE:] La fuerza del mordisco, utilizada para desplazar a otro agente de su posición cuando el primero desea ocuparla para poder comerse una ración de comida.
\item[FEATURE\_FUR:] Cantidad de pelaje, que sirve a la rata para defenderse de una dentellada de su atacante que intenta desplazarla a otra posición.
\item[FEATURE\_PROFILE\_VARIANCE:] Variabilidad de las caracterícticas de los agentes que tienen este perfil.
\item[FEATURE\_HEALTH:] Vitalidad del agente que define sus puntos de vida.
\item[FEATURE\_LIFE:] Edad máxima del agente.
\item[FEATURE\_SMELL:] Radio de visión del agente para buscar comida, realizar movimientos o localizar pareja.
\item[FEATURE\_METHABOLISM:] Energía que aporta cada porción de comida
\item[FEATURE\_HUNGRY\_LEVEL:] Facilidad para sentir hambre ante una baja energía.
\item[FEATURE\_PROCREATION:] Necesidad de procreación del agente (hembra)
\item[FEATURE\_ENJOYABLE:] Carisma del agente o facilidad para encontrar pareja.
\item[FEATURE\_AGE\_TO\_BE\_ADULT:] Define la edad a partir de la cual una rata se considera adulta y por lo tanto puede procrear.
\item[FEATURE\_PREGNANCY\_TIME:] Duración del embarazo del agente (hembra)
\item[FEATURE\_KINDNESS:] Amabilidad o probabilidad de que el agente ceda su posición a otro para que este pueda obtener comida.
\end{description} 

Todos los parámetros anteriores deben tener valores comprendidos entre 0 y 1.
%TODO mal explicado

Además, existen una serie de propiedades que  serán constantes a lo largo del
experimento y que se deben definir en el fichero ``evaluation.properties'': Se
trata de los valores base utilizados para el cálculo
de las características de los agentes, y que deben amoldarse en la medida de lo
posible a naturaleza de los agentes modelados, en este caso, las ratas. Por
ejemplo, se sabe que la especie Rattus norvegicus vive unos 10 meses en
libertad, son agresivas, activamente sexuales a las 5 semanas y su periodo de
gestación es de un mes.

\begin{verbatim}
# ---
# Base agent features
# about 10 months
base.BASE_DAYS = 200
base.BASE_ENERGY = 5
base.BASE_SMELL = 3
base.BASE_NUTRITION = 4
base.BASE_BITE = 5
base.BASE_FUR = 5
# 6 weeks
base.BASE_AGE_TO_BE_ADULT_FEMALE = 42
# 7 weeks
base.BASE_AGE_TO_BE_ADULT_MALE = 49
# 7 weeks
base.BASE_PREGNANCY_TIME = 30
#---
\end{verbatim}

\subsubsection{Características básicas}


\begin{table}[h]
\centering % centering table
\begin{tabular}{| p{3cm} | p{10cm} |} % creating eight columns
\hline\hline
Caracteríctica & Descripción\\
\hline % inserts single-line
Id & Identificador único de la rata en este entorno \\
Nombre & Nombre de origen británico, seleccionado al azar\\
Nombre de pila & Sustantivo de la familia de palabras ``queso'' o
``alcantarillado''. Si la rata es huérfana se elige al azar. En caso contrario
se escoge de la madre \\
Apellidos & Apellido de origen británico, seleccionado al azar si la rata es
huérfana o heredado del padre si no lo es \\
Género & Masculino o femenino \\
Perfil & Número entero mayor o igual a 0 y menor que el número de perfiles del
experimento \\
Edad & Edad medida en días de la rata \\
Edad adulta & Edad a partir de la cual la rata podrá buscar pareja \\
Edad máxima & Edad máxima de la rata definida por su perfil más una componente
aleatoria \\
Variabilidad de los indivíduos del perfil & Número real que define cuanto
pueden separarse los valores del perfil de los indivíduos para ciertas
características respecto a los correspondientes al perfil\\
Energía & Número entero que define el nivel de energía de la rata. Cuando éste
llega a 0, la rata ha muerto \\
Energía máxima & Máximo nivel de energía de la rata \\
Olfato & Distancia medida en celdas con la que puede interactuar la rata en un
turno, ya sea para buscar alimento, pareja o desplazarse  \\
Metabolismo & Cantidad de energía que aporta cada ración de comida \\
Dentellada & Fuerza con la que ataca una rata a otra para desplazarla y acceder
a la celda con comida \\
Pelaje & Medida de la defensa de una rata ante una dentellada \\
Amabilidad & Probabilidad de que una rata se aparte de propia voluntad ante un
ataque de otra rata \\
Tendencia al hambre & Tendencia que tiene una rata de tener hambre en función
de su nivel de energía\\
\hline % inserts single-line
\end{tabular}
\label{tab:caracteristicas}
\caption{Características de un agente (1/2)} %title of the table
\end{table}


\begin{table}[h]
\centering % centering table
\begin{tabular}{| p{3cm} | p{10cm} |} % creating eight columns
\hline\hline
Caracteríctica & Descripción\\
\hline % inserts single-line
Tendencia a la procreación & tendencia que tiene una rata hembra a buscar
pareja una vez alcanzada la edad adulta \\
Carisma & Facilidad para encontrar pareja \\
Personalidad & Valor real que indica la personalidad de la rata, de manera que
las afinidades de las ratas se midan por la distancia de sus personalidades
(donde 1 y 0 se corresponden con la misma personalidad). \\
Estado: viva & La rata está viva \\
Estado: embarazada & Valor entero. Si es igual a 0, la rata no está embarazada,
en cualquier otro caso son los días que le quedan para dar a luz \\
Enamorada & Si la rata es pareja de otra rata \\
\hline % inserts single-line
\end{tabular}
\label{tab:caracteristicas}
\caption{Características de un agente (2/2)} %title of the table
\end{table}


\subsubsection{Paso del tiempo}

Cada iteración del Entorno Made ejecuta un día de la vida de todos los agentes,
de manera aleatoria. En cada llamada al agente, este aumenta su vida en un día y
disminuye en uno su energía.

\subsubsection{Alimentación}

Cada agente se ve obligado a comer para sobrevivir. Existe una tendencia del
perfil de la rata para sentir hambre ante baja energía. La posibilidad de comer
depende de varias necesidades:
\begin{itemize}
 \item que la rata pueda oler la comida (olfato)
 \item que la celda con comida esté vacía
 \item si la celda no está vacía, que la rata pueda expulsar a la otra
(dentellada contra pelaje) o que la segunda sea lo suficientemente amable como
para apartarse.
\end{itemize}


\subsubsection{Competitividad}

Para que un agente pueda comer una ración de comida, éste ha de estar en la
misma celda. Esto implica que, si no hay una ración de comida cercana que esté
sobre una celda vacía, la rata buscará celdas ocupadas y tendrá que desplazar a
otras ratas. Si se produce enfrentamiento y se comparan la dentellada de la
primera y el pelaje de la segunda.

\begin{itemize}
 \item Si la primera rata gana, desplaza a la
segunda y además le hace daño por valor de un punto de energía. Si no existe
hueco a distancia 1 de la celda, la rata muere.
 \item Si la primera
rata pierde, la segunda no se mueve y la primera tendrá que esperar otro turno
para comer.
\end{itemize}


\subsubsection{Mecanismos de disminución de la fricción}

Una rata, en función de su nivel de amabilidad puede dejar a otra rata comerse
una ración de comida sobre la que se encuentra. 

\subsubsection{Paternidad / Maternidad}

Dos ratas pueden tener descendencia (o ratas hijas). En este entorno un poco
humanizado de la Universidad de la magia, para que dos ratas tengan hijos
deben producirse las siguientes condiciones:
\begin{itemize}
 \item Las dos ratas (a y b) deben ser maduras
 \item Las ratas son compatibles si se cumple
$$
\frac{\frac{carisma(a)+casrisma(b)}{2}}{\frac{distancia(personalidad(a),
personalidad(b))}{5} } >= 1
$$
 \item La rata hembra queda embarazada

Pasado el tiempo de gestación, la rata hembra tendrá una cantidad de
descendientes. Las ratas descendientes tendrá un nombre al azar, el nombre de
pila del padre y el apellido de la madre. El perfil de la rata tendrá un
33\% de probabilidades de ser el del padre, un 33º de ser el de la madre y el
resto de ser uno al azar. 
 
\end{itemize}

\subsubsection{Ciclo de vida}

cada iteración del Entorno MADE ejecutará el método \textit{justLive} de cada
agente, cuya misión es la de representar (de manera muy abstracta,
simplificada, resumida y poco detallada) un día en la vida de nuestras ratas.\\

El pseudocódigo para la ejecución principal del entorno MADE es el siguiente:

\begin{enumerate}
 \item Para i, desde 0 hasta número inicial de agentes
 \begin{enumerate}
  \item Crear un nuevo agente: id = i, perfil = i \% número de perfiles 
  \item posicionar al agente en el mapa
 \end{enumerate}
 \item Para currDate, desde 0 hasta número total de días
 \begin{enumerate}
  \item Colocar comida en posiciones aleatorias del mapa
  \item l = agentes vivos
  \item desordenar l
  \item Para cada ag, perteneciente a l
  \begin{enumerate}
   \item ejecutar ag
  \end{enumerate}
  \item Retirar agentes no vivos del mapa 
 \end{enumerate}
\end{enumerate}

El pseudocódigo para la ejecución del agente es el siguiente:

\begin{enumerate}
 \item días vividos + +
 \item energía --
 \item Si embarazada > 0
 \begin{enumerate}
  \item embarazada - -
  \item Si embarazada == 0
  \begin{enumerate}
   \item Nacimiento de máximo 10 agentes que heredan nombre y perfil de los
padres
  \end{enumerate}
 \end{enumerate}
 
 \item Si días vividos mayor que Edad máxima o energía menor o igual que 0
 \begin{enumerate}
  \item vivo = false
 \end{enumerate}
 \item Si no
 \begin{enumerate}
  \item Si tiene hambre
  \begin{enumerate}
   \item p = Buscar posición cercana con comida y sin ocupar
   \begin{enumerate}
    \item Si p no existe
    \begin{itemize}
     \item p = Buscar posición cercana con comida y ocupada
     \item Si p existe
     \begin{itemize}
      \item Si agente atacado es amable
      \begin{itemize}
       \item mover agente atacado a una posición cercana
      \end{itemize}
      \item Si no, si dentellada es mayor que pelaje del objetivo
      \begin{itemize}
       \item mover agente atacado una posición cercana
       \item energía de agente atacado - -
      \end{itemize}
     \end{itemize}
    \end{itemize}
   \end{enumerate}
   \item Si p existe
   \begin{enumerate}
    \item mover a p
    \item comer una ración
    \item energía += metabolismo
   \end{enumerate}
  \end{enumerate}
  \item Si no,  Si es mujer y embarazada == 0 y desea tener descendencia y no
tiene pareja
  \begin{enumerate}
   \item l = buscar agentes masculinos cerca
   \item Si l existe
   \begin{enumerate}
    \item ag = primer agente compatible
    \item Si ag existe
    \begin{itemize}
     \item ag es pareja
     \item embarazo = tiempo de gestación
    \end{itemize}
   \end{enumerate}
  \end{enumerate}
  \item Si no, desplazarse por el mapa
 \end{enumerate}
\end{enumerate}






\subsubsection{Perfiles y variabilidad}

Un perfil es un conjunto de parámetros que definen los valores que pueden tener
las caracterícticas de los agentes. En función de los objetivos esperados podrá
ser recomendable trabajar con un número de perfiles dado. Los valores que
pueden tomar las características de las ratas dependerán de los valores del
perfil, los valores base y su variabilidad. Por ejemplo, en caso de que
existiese un único perfil con variabilidad 0, todas las ratas tendrían las
mismas caracterícticas. Si el perfil tiene una alta variabilidad los valores
podrán oscilar entre el valor base y 3*el valor base.

Las caracterícticas Edad máxima, energía máxima, Olfato, metabolismo,
dentellada, pelaje y tiempo de embarazo, utilizan para su cálculo unos valores
base que han sido elegidos para buscar la semejanza con el modelo real de rata.
La fórmula para realizar el cálculo de una característica es la siguiente:

$$ valor = base 
                + (base * perfil)
                + (base_c * perfil * ( 2*rand - 1) * variacion);
$$


\subsubsection{Registro de actividad de cada agente}

Las transiciones entre estados generan una secuencia de registros en formato
log, que, junto a una ficha personal, detallan la vida de cada agente y permiten
su posterior análisis.

Las líneas del registro tendrá el siguiente formato:
\begin{verbatim}
  <edad_en_días>:@<ACCIÓN> <PARÁMETROS>
\end{verbatim}

\begin{table}[h]
\centering % centering table
\begin{tabular}{| p{4cm} | p{5cm} | p{4cm} |} % creating eight columns
\hline\hline
Acción & Detalle & Parámetros \\
\hline % inserts single-line

    BORN genero & El agente ha nacido & Género del agente \\
    HUNGRY energía & El agente siente hambre & nivel de energía \\
    EAT energía & El agente ha comido una ración & nivel de energía \\
    NUDGE\_OK id & El agente ha desplazado violentamente a otro para comer &
id del agente desplazado\\
    NUDGED id & El agente ha sido desplazado por otro & id del agente
atacante \\
    NUDGE\_FAILED id & El agente ha intentado desplazar a otro agente
fallidamente & id del agente defendido \\
    DEFENDED id & El agente se ha defendido de un intento de desplazamiento &
id del agente atacante\\
    MOVE\_TO\_EAT x y & El agente se desplaza para buscar comida &
coordenadas x e y de la nueva posición \\
    LOOK\_FOR\_PARTNER & El agente busca pareja & \\
    PARTNER\_FOUND id & El agente ha encontrado una pareja compatible & id de
la pareja \\
    PREGNANT días & El agente (femenino) está embarazado & días que durará el
embarazo \\
    PARENT id & El agente ha sido padre / madre de otro agente & id del
agente nacido \\
    FREE\_TIME & El agente está ocioso, disfrutando del tiempo libre & \\
    DIE edad & El agente ha muerto & edad del agente en la fecha de su muerte \\


\hline % inserts single-line
\end{tabular}
\label{tab:caracteristicas}
\caption{Características de un agente (2/2)} %title of the table
\end{table}


